'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});

var _events = require('events');

var _graphql = require('graphql');

var _values = require('graphql/execution/values');

var _validation = require('./validation');

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var SubscriptionManager = function () {
	function SubscriptionManager(options) {
		_classCallCheck(this, SubscriptionManager);

		this.pubsub = options.pubsub;
		this.schema = options.schema;
		this.setupFunctions = options.setupFunctions || {};
		this.subscriptions = {};
		this.maxSubscriptionId = 0;
	}

	SubscriptionManager.prototype.publish = function publish(triggerName, payload) {
		this.pubsub.publish(triggerName, payload);
	};

	SubscriptionManager.prototype.subscribe = function subscribe(options) {

		// 1. validate the query, operationName and variables
		var parsedQuery = (0, _graphql.parse)(options.query);
		var errors = (0, _graphql.validate)(this.schema, parsedQuery, [..._graphql.specifiedRules, _validation.subscriptionHasSingleRootField]);

		// TODO: validate that all variables have been passed (and are of correct type)?
		if (errors.length) {
			// this error kills the subscription, so we throw it.
			return Promise.reject < number > new ValidationError(errors);
		}

		var args = {};

		// operationName is the name of the only root field in the subscription document
		var subscriptionName = '';
		parsedQuery.definitions.forEach(definition => {
			if (definition.kind === 'OperationDefinition') {
				// only one root field is allowed on subscription. No fragments for now.
				var rootField = definition.selectionSet.selections[0];
				subscriptionName = rootField.name.value;

				var fields = this.schema.getSubscriptionType().getFields();
				args = (0, _values.getArgumentValues)(fields[subscriptionName], rootField, options.variables);
			}
		});

		var triggerMap = void 0;

		if (this.setupFunctions[subscriptionName]) {
			triggerMap = this.setupFunctions[subscriptionName](options, args, subscriptionName);
		} else {
			// if not provided, the triggerName will be the subscriptionName, The trigger will not have any
			// options and rely on defaults that are set later.
			triggerMap = { [subscriptionName]: {} };
		}

		var externalSubscriptionId = this.maxSubscriptionId++;
		this.subscriptions[externalSubscriptionId] = [];
		var subscriptionPromises = [];
		Object.keys(triggerMap).forEach(triggerName => {
			// Deconstruct the trigger options and set any defaults
			var _triggerMap$triggerNa = triggerMap[triggerName],
			    _triggerMap$triggerNa2 = _triggerMap$triggerNa.channelOptions,
			    channelOptions = _triggerMap$triggerNa2 === undefined ? {} : _triggerMap$triggerNa2,
			    _triggerMap$triggerNa3 = _triggerMap$triggerNa.filter,
			    filter = _triggerMap$triggerNa3 === undefined ? () => true : _triggerMap$triggerNa3;

			// 2. generate the handler function
			//
			// rootValue is the payload sent by the event emitter / trigger by
			// convention this is the value returned from the mutation
			// resolver

			var onMessage = rootValue => {
				return Promise.resolve().then(() => {
					if (typeof options.context === 'function') {
						return options.context();
					}
					return options.context;
				}).then(context => {
					return Promise.all([context, filter(rootValue, context)]);
				}).then(([context, doExecute]) => {
					if (!doExecute) {
						return;
					}
					(0, _graphql.execute)(this.schema, parsedQuery, rootValue, context, options.variables, options.operationName).then(data => {
						return options.callback(data.errors, data);
					});
				}).catch(error => {
					options.callback(error);
				});
			};

			// 3. subscribe and keep the subscription id
			subscriptionPromises.push(this.pubsub.subscribe(triggerName, onMessage, channelOptions).then(id => this.subscriptions[externalSubscriptionId].push(id)));
		});

		// Resolve the promise with external sub id only after all subscriptions completed
		return Promise.all(subscriptionPromises).then(() => externalSubscriptionId);
	};

	SubscriptionManager.prototype.unsubscribe = function unsubscribe(subId) {
		// pass the subId right through to pubsub. Do nothing else.
		this.subscriptions[subId].forEach(internalId => {
			this.pubsub.unsubscribe(internalId);
		});
		delete this.subscriptions[subId];
	};

	return SubscriptionManager;
}();

;

exports.default = SubscriptionManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYW5hZ2VyLmpzIl0sIm5hbWVzIjpbIlN1YnNjcmlwdGlvbk1hbmFnZXIiLCJvcHRpb25zIiwicHVic3ViIiwic2NoZW1hIiwic2V0dXBGdW5jdGlvbnMiLCJzdWJzY3JpcHRpb25zIiwibWF4U3Vic2NyaXB0aW9uSWQiLCJwdWJsaXNoIiwidHJpZ2dlck5hbWUiLCJwYXlsb2FkIiwic3Vic2NyaWJlIiwicGFyc2VkUXVlcnkiLCJxdWVyeSIsImVycm9ycyIsImxlbmd0aCIsIlByb21pc2UiLCJyZWplY3QiLCJudW1iZXIiLCJWYWxpZGF0aW9uRXJyb3IiLCJhcmdzIiwic3Vic2NyaXB0aW9uTmFtZSIsImRlZmluaXRpb25zIiwiZm9yRWFjaCIsImRlZmluaXRpb24iLCJraW5kIiwicm9vdEZpZWxkIiwic2VsZWN0aW9uU2V0Iiwic2VsZWN0aW9ucyIsIm5hbWUiLCJ2YWx1ZSIsImZpZWxkcyIsImdldFN1YnNjcmlwdGlvblR5cGUiLCJnZXRGaWVsZHMiLCJ2YXJpYWJsZXMiLCJ0cmlnZ2VyTWFwIiwiZXh0ZXJuYWxTdWJzY3JpcHRpb25JZCIsInN1YnNjcmlwdGlvblByb21pc2VzIiwiT2JqZWN0Iiwia2V5cyIsImNoYW5uZWxPcHRpb25zIiwiZmlsdGVyIiwib25NZXNzYWdlIiwicm9vdFZhbHVlIiwicmVzb2x2ZSIsInRoZW4iLCJjb250ZXh0IiwiYWxsIiwiZG9FeGVjdXRlIiwib3BlcmF0aW9uTmFtZSIsImRhdGEiLCJjYWxsYmFjayIsImNhdGNoIiwiZXJyb3IiLCJwdXNoIiwiaWQiLCJ1bnN1YnNjcmliZSIsInN1YklkIiwiaW50ZXJuYWxJZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7O0FBQ0E7O0FBVUE7O0FBRUE7Ozs7SUFLTUEsbUI7QUFFTCw4QkFBWUMsT0FBWixFQUFvQjtBQUFBOztBQUNuQixPQUFLQyxNQUFMLEdBQWNELFFBQVFDLE1BQXRCO0FBQ0EsT0FBS0MsTUFBTCxHQUFjRixRQUFRRSxNQUF0QjtBQUNBLE9BQUtD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QWdCO0FBQ2pCO0FBQ0U7QUFDRCwyQkFDQyxLQUFLNUMsTUFETixFQUVDUSxXQUZELEVBR0MrQixTQUhELEVBSUNHLE9BSkQsRUFLQzVDLFFBQVFnQyxTQUxULEVBTUNoQyxRQUFRK0MsYUFOVCxFQU9FSixJQVBGLENBT1FLLFFBQVE7QUFDaEIsYUFBT2hELFFBQVFpRCxRQUFSLENBQWlCRCxLQUFLcEMsTUFBdEIsRUFBOEJvQyxJQUE5QixDQUFQO0FBQ0MsTUFURDtBQVVELEtBeEJNLEVBd0JKRSxLQXhCSSxDQXdCR0MsS0FBRCxJQUFXO0FBQ25CbkQsYUFBUWlELFFBQVIsQ0FBaUJFLEtBQWpCO0FBQ0EsS0ExQk0sQ0FBUDtBQTJCQSxJQTVCRDs7QUE4QkE7QUFDQWhCLHdCQUFxQmlCLElBQXJCLENBQ0MsS0FBS25ELE1BQUwsQ0FBWVEsU0FBWixDQUFzQkYsV0FBdEIsRUFBbUNpQyxTQUFuQyxFQUE4Q0YsY0FBOUMsRUFDRUssSUFERixDQUNPVSxNQUFNLEtBQUtqRCxhQUFMLENBQW1COEIsc0JBQW5CLEVBQTJDa0IsSUFBM0MsQ0FBZ0RDLEVBQWhELENBRGIsQ0FERDtBQUlBLEdBL0NEOztBQWlEQTtBQUNBLFNBQU92QyxRQUFRK0IsR0FBUixDQUFZVixvQkFBWixFQUFrQ1EsSUFBbEMsQ0FBdUMsTUFBTVQsc0JBQTdDLENBQVA7QUFDQSxFOzsrQkFFRG9CLFcsd0JBQVlDLEssRUFBTTtBQUNqQjtBQUNBLE9BQUtuRCxhQUFMLENBQW1CbUQsS0FBbkIsRUFBMEJsQyxPQUExQixDQUFtQ21DLGNBQWM7QUFDaEQsUUFBS3ZELE1BQUwsQ0FBWXFELFdBQVosQ0FBd0JFLFVBQXhCO0FBQ0EsR0FGRDtBQUdBLFNBQU8sS0FBS3BELGFBQUwsQ0FBbUJtRCxLQUFuQixDQUFQO0FBQ0EsRTs7Ozs7QUFDRDs7a0JBRWN4RCxtQiIsImZpbGUiOiJtYW5hZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJ1xuaW1wb3J0IHtcblx0R3JhcGhRTFNjaGVtYSxcblx0R3JhcGhRTEVycm9yLFxuXHR2YWxpZGF0ZSxcblx0ZXhlY3V0ZSxcblx0cGFyc2UsXG5cdHNwZWNpZmllZFJ1bGVzLFxuXHRPcGVyYXRpb25EZWZpbml0aW9uLFxuXHRGaWVsZCxcbn0gZnJvbSAnZ3JhcGhxbCdcbmltcG9ydCB7IGdldEFyZ3VtZW50VmFsdWVzIH0gZnJvbSAnZ3JhcGhxbC9leGVjdXRpb24vdmFsdWVzJ1xuXG5pbXBvcnQge1xuXHRzdWJzY3JpcHRpb25IYXNTaW5nbGVSb290RmllbGQsXG59IGZyb20gJy4vdmFsaWRhdGlvbidcblxuXG5jbGFzcyBTdWJzY3JpcHRpb25NYW5hZ2VyIHtcblx0XG5cdGNvbnN0cnVjdG9yKG9wdGlvbnMpe1xuXHRcdHRoaXMucHVic3ViID0gb3B0aW9ucy5wdWJzdWI7XG5cdFx0dGhpcy5zY2hlbWEgPSBvcHRpb25zLnNjaGVtYTtcblx0XHR0aGlzLnNldHVwRnVuY3Rpb25zID0gb3B0aW9ucy5zZXR1cEZ1bmN0aW9ucyB8fCB7fTtcblx0XHR0aGlzLnN1YnNjcmlwdGlvbnMgPSB7fTtcblx0XHR0aGlzLm1heFN1YnNjcmlwdGlvbklkID0gMDtcblx0fVxuXG5cdHB1Ymxpc2godHJpZ2dlck5hbWUsIHBheWxvYWQpe1xuXHRcdHRoaXMucHVic3ViLnB1Ymxpc2godHJpZ2dlck5hbWUsIHBheWxvYWQpO1xuXHR9XG5cblx0c3Vic2NyaWJlKG9wdGlvbnMpe1xuXG5cdFx0Ly8gMS4gdmFsaWRhdGUgdGhlIHF1ZXJ5LCBvcGVyYXRpb25OYW1lIGFuZCB2YXJpYWJsZXNcblx0XHRjb25zdCBwYXJzZWRRdWVyeSA9IHBhcnNlKG9wdGlvbnMucXVlcnkpO1xuXHRcdGNvbnN0IGVycm9ycyA9IHZhbGlkYXRlKFxuXHRcdFx0dGhpcy5zY2hlbWEsXG5cdFx0XHRwYXJzZWRRdWVyeSxcblx0XHRcdFsuLi5zcGVjaWZpZWRSdWxlcywgc3Vic2NyaXB0aW9uSGFzU2luZ2xlUm9vdEZpZWxkXVxuXHRcdCk7XG5cblx0XHQvLyBUT0RPOiB2YWxpZGF0ZSB0aGF0IGFsbCB2YXJpYWJsZXMgaGF2ZSBiZWVuIHBhc3NlZCAoYW5kIGFyZSBvZiBjb3JyZWN0IHR5cGUpP1xuXHRcdGlmIChlcnJvcnMubGVuZ3RoKXtcblx0XHRcdC8vIHRoaXMgZXJyb3Iga2lsbHMgdGhlIHN1YnNjcmlwdGlvbiwgc28gd2UgdGhyb3cgaXQuXG5cdFx0XHRyZXR1cm4gUHJvbWlzZS5yZWplY3Q8bnVtYmVyPihuZXcgVmFsaWRhdGlvbkVycm9yKGVycm9ycykpO1xuXHRcdH1cblxuXHRcdGxldCBhcmdzID0ge307XG5cblx0XHQvLyBvcGVyYXRpb25OYW1lIGlzIHRoZSBuYW1lIG9mIHRoZSBvbmx5IHJvb3QgZmllbGQgaW4gdGhlIHN1YnNjcmlwdGlvbiBkb2N1bWVudFxuXHRcdGxldCBzdWJzY3JpcHRpb25OYW1lID0gJyc7XG5cdFx0cGFyc2VkUXVlcnkuZGVmaW5pdGlvbnMuZm9yRWFjaCggZGVmaW5pdGlvbiA9PiB7XG5cdFx0XHRpZiAoZGVmaW5pdGlvbi5raW5kID09PSAnT3BlcmF0aW9uRGVmaW5pdGlvbicpe1xuXHRcdFx0XHQvLyBvbmx5IG9uZSByb290IGZpZWxkIGlzIGFsbG93ZWQgb24gc3Vic2NyaXB0aW9uLiBObyBmcmFnbWVudHMgZm9yIG5vdy5cblx0XHRcdFx0Y29uc3Qgcm9vdEZpZWxkID0gKGRlZmluaXRpb24pLnNlbGVjdGlvblNldC5zZWxlY3Rpb25zWzBdO1xuXHRcdFx0XHRzdWJzY3JpcHRpb25OYW1lID0gcm9vdEZpZWxkLm5hbWUudmFsdWU7XG5cblx0XHRcdFx0Y29uc3QgZmllbGRzID0gdGhpcy5zY2hlbWEuZ2V0U3Vic2NyaXB0aW9uVHlwZSgpLmdldEZpZWxkcygpO1xuXHRcdFx0XHRhcmdzID0gZ2V0QXJndW1lbnRWYWx1ZXMoZmllbGRzW3N1YnNjcmlwdGlvbk5hbWVdLCByb290RmllbGQsIG9wdGlvbnMudmFyaWFibGVzKTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdGxldCB0cmlnZ2VyTWFwO1xuXG5cdFx0aWYgKHRoaXMuc2V0dXBGdW5jdGlvbnNbc3Vic2NyaXB0aW9uTmFtZV0pIHtcblx0XHRcdHRyaWdnZXJNYXAgPSB0aGlzLnNldHVwRnVuY3Rpb25zW3N1YnNjcmlwdGlvbk5hbWVdKG9wdGlvbnMsIGFyZ3MsIHN1YnNjcmlwdGlvbk5hbWUpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHQvLyBpZiBub3QgcHJvdmlkZWQsIHRoZSB0cmlnZ2VyTmFtZSB3aWxsIGJlIHRoZSBzdWJzY3JpcHRpb25OYW1lLCBUaGUgdHJpZ2dlciB3aWxsIG5vdCBoYXZlIGFueVxuXHRcdFx0Ly8gb3B0aW9ucyBhbmQgcmVseSBvbiBkZWZhdWx0cyB0aGF0IGFyZSBzZXQgbGF0ZXIuXG5cdFx0XHR0cmlnZ2VyTWFwID0ge1tzdWJzY3JpcHRpb25OYW1lXToge319O1xuXHRcdH1cblxuXHRcdGNvbnN0IGV4dGVybmFsU3Vic2NyaXB0aW9uSWQgPSB0aGlzLm1heFN1YnNjcmlwdGlvbklkKys7XG5cdFx0dGhpcy5zdWJzY3JpcHRpb25zW2V4dGVybmFsU3Vic2NyaXB0aW9uSWRdID0gW107XG5cdFx0Y29uc3Qgc3Vic2NyaXB0aW9uUHJvbWlzZXMgPSBbXTtcblx0XHRPYmplY3Qua2V5cyh0cmlnZ2VyTWFwKS5mb3JFYWNoKCB0cmlnZ2VyTmFtZSA9PiB7XG5cdFx0XHQvLyBEZWNvbnN0cnVjdCB0aGUgdHJpZ2dlciBvcHRpb25zIGFuZCBzZXQgYW55IGRlZmF1bHRzXG5cdFx0XHRjb25zdCB7XG5cdFx0XHRcdGNoYW5uZWxPcHRpb25zID0ge30sXG5cdFx0XHRcdGZpbHRlciA9ICgpID0+IHRydWUsIC8vIExldCBhbGwgbWVzc2FnZXMgdGhyb3VnaCBieSBkZWZhdWx0LlxuXHRcdFx0fSA9IHRyaWdnZXJNYXBbdHJpZ2dlck5hbWVdO1xuXG5cdFx0XHQvLyAyLiBnZW5lcmF0ZSB0aGUgaGFuZGxlciBmdW5jdGlvblxuXHRcdFx0Ly9cblx0XHRcdC8vIHJvb3RWYWx1ZSBpcyB0aGUgcGF5bG9hZCBzZW50IGJ5IHRoZSBldmVudCBlbWl0dGVyIC8gdHJpZ2dlciBieVxuXHRcdFx0Ly8gY29udmVudGlvbiB0aGlzIGlzIHRoZSB2YWx1ZSByZXR1cm5lZCBmcm9tIHRoZSBtdXRhdGlvblxuXHRcdFx0Ly8gcmVzb2x2ZXJcblx0XHRcdGNvbnN0IG9uTWVzc2FnZSA9IChyb290VmFsdWUpID0+IHtcblx0XHRcdFx0cmV0dXJuIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4ge1xuXHRcdFx0XHRcdGlmICh0eXBlb2Ygb3B0aW9ucy5jb250ZXh0ID09PSAnZnVuY3Rpb24nKSB7XG5cdFx0XHRcdFx0XHRyZXR1cm4gb3B0aW9ucy5jb250ZXh0KCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdHJldHVybiBvcHRpb25zLmNvbnRleHQ7XG5cdFx0XHRcdH0pLnRoZW4oKGNvbnRleHQpID0+IHtcblx0XHRcdFx0XHRyZXR1cm4gUHJvbWlzZS5hbGwoW1xuXHRcdFx0XHRcdFx0Y29udGV4dCxcblx0XHRcdFx0XHRcdGZpbHRlcihyb290VmFsdWUsIGNvbnRleHQpLFxuXHRcdFx0XHRcdF0pO1xuXHRcdFx0XHR9KS50aGVuKChbY29udGV4dCwgZG9FeGVjdXRlXSkgPT4ge1xuXHRcdFx0XHQgIGlmICghZG9FeGVjdXRlKSB7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHQgIH1cblx0XHRcdFx0ICBleGVjdXRlKFxuXHRcdFx0XHRcdCAgdGhpcy5zY2hlbWEsXG5cdFx0XHRcdFx0ICBwYXJzZWRRdWVyeSxcblx0XHRcdFx0XHQgIHJvb3RWYWx1ZSxcblx0XHRcdFx0XHQgIGNvbnRleHQsXG5cdFx0XHRcdFx0ICBvcHRpb25zLnZhcmlhYmxlcyxcblx0XHRcdFx0XHQgIG9wdGlvbnMub3BlcmF0aW9uTmFtZVxuXHRcdFx0XHQgICkudGhlbiggZGF0YSA9PiB7XG5cdFx0XHRcdFx0IHJldHVybiBvcHRpb25zLmNhbGxiYWNrKGRhdGEuZXJyb3JzLCBkYXRhKTtcblx0XHRcdFx0ICB9KTtcblx0XHRcdFx0fSkuY2F0Y2goKGVycm9yKSA9PiB7XG5cdFx0XHRcdFx0b3B0aW9ucy5jYWxsYmFjayhlcnJvcik7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fTtcblxuXHRcdFx0Ly8gMy4gc3Vic2NyaWJlIGFuZCBrZWVwIHRoZSBzdWJzY3JpcHRpb24gaWRcblx0XHRcdHN1YnNjcmlwdGlvblByb21pc2VzLnB1c2goXG5cdFx0XHRcdHRoaXMucHVic3ViLnN1YnNjcmliZSh0cmlnZ2VyTmFtZSwgb25NZXNzYWdlLCBjaGFubmVsT3B0aW9ucylcblx0XHRcdFx0XHQudGhlbihpZCA9PiB0aGlzLnN1YnNjcmlwdGlvbnNbZXh0ZXJuYWxTdWJzY3JpcHRpb25JZF0ucHVzaChpZCkpXG5cdFx0XHQpO1xuXHRcdH0pO1xuXG5cdFx0Ly8gUmVzb2x2ZSB0aGUgcHJvbWlzZSB3aXRoIGV4dGVybmFsIHN1YiBpZCBvbmx5IGFmdGVyIGFsbCBzdWJzY3JpcHRpb25zIGNvbXBsZXRlZFxuXHRcdHJldHVybiBQcm9taXNlLmFsbChzdWJzY3JpcHRpb25Qcm9taXNlcykudGhlbigoKSA9PiBleHRlcm5hbFN1YnNjcmlwdGlvbklkKTtcblx0fVxuXG5cdHVuc3Vic2NyaWJlKHN1YklkKXtcblx0XHQvLyBwYXNzIHRoZSBzdWJJZCByaWdodCB0aHJvdWdoIHRvIHB1YnN1Yi4gRG8gbm90aGluZyBlbHNlLlxuXHRcdHRoaXMuc3Vic2NyaXB0aW9uc1tzdWJJZF0uZm9yRWFjaCggaW50ZXJuYWxJZCA9PiB7XG5cdFx0XHR0aGlzLnB1YnN1Yi51bnN1YnNjcmliZShpbnRlcm5hbElkKTtcblx0XHR9KTtcblx0XHRkZWxldGUgdGhpcy5zdWJzY3JpcHRpb25zW3N1YklkXTtcblx0fVxufTtcblxuZXhwb3J0IGRlZmF1bHQgU3Vic2NyaXB0aW9uTWFuYWdlcjtcbiJdfQ==