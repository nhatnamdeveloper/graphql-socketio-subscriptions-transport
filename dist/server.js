import { EVENT_KEY } from './definitions';

import { SUBSCRIPTION_FAIL, SUBSCRIPTION_DATA, SUBSCRIPTION_START, SUBSCRIPTION_END, SUBSCRIPTION_SUCCESS } from './messageTypes';

export default class Server {
	constructor({ subscriptionManager }, ref) {
		if (!subscriptionManager) {
			throw new Error('Must provide `subscriptionManager` to websocket server constructor.');
		}

		this.ws = ref;
		this.subscriptionManager = subscriptionManager;

		this.ws.on('connection', this.handleConnection.bind(this));
	}

	sendSubscriptionData(socket, id, payload) {
		socket.emit(EVENT_KEY, {
			type: SUBSCRIPTION_DATA,
			id,
			payload
		});
	}

	sendSubscriptionFail(socket, id, payload) {
		socket.emit(EVENT_KEY, {
			type: SUBSCRIPTION_FAIL,
			id,
			payload
		});
	}

	sendSubscriptionSuccess(socket, id) {
		socket.emit(EVENT_KEY, {
			type: SUBSCRIPTION_SUCCESS,
			id
		});
	}

	handleConnection(socket) {
		const connectionSubscriptions = {};

		socket.on(EVENT_KEY, this.onMessage(socket, connectionSubscriptions));
		socket.on('disconnect', this.onClose(socket, connectionSubscriptions));
	}

	onClose(socket, connectionSubscriptions) {
		return () => {
			Object.keys(connectionSubscriptions).forEach(subId => {
				this.subscriptionManager.unsubscribe(connectionSubscriptions[subId]);
				delete connectionSubscriptions[subId];
			});
		};
	}

	onMessage(socket, connectionSubscriptions) {
		return async ({ id, type, query, variables, operationName }) => {
			switch (type) {
				case SUBSCRIPTION_START:
					const params = {
						query,
						variables,
						operationName,
						context: {},
						formatResponse: undefined,
						formatError: undefined,
						callback: (error, result) => {
							if (!error) {
								this.sendSubscriptionData(socket, id, result);
							} else if (error.errors) {
								this.sendSubscriptionData(socket, id, { errors: error.errors });
							} else {
								this.sendSubscriptionData(socket, id, { errors: [{ message: error.message }] });
							}
						}
					};

					if (connectionSubscriptions[id]) {
						this.subscriptionManager.unsubscribe(connectionSubscriptions[id]);
						delete connectionSubscriptions[id];
					}

					try {
						const subId = await this.subscriptionManager.subscribe(params);
						connectionSubscriptions[id] = subId;
						this.sendSubscriptionSuccess(socket, id);
					} catch ({ errors, message }) {
						if (errors) {
							this.sendSubscriptionFail(socket, id, { errors });
						} else {
							this.sendSubscriptionFail(socket, id, { errors: [{ message }] });
						}
					}

					break;
				case SUBSCRIPTION_END:
					if (typeof connectionSubscriptions[id] !== 'undefined') {
						this.subscriptionManager.unsubscribe(connectionSubscriptions[id]);
						delete connectionSubscriptions[id];
					}

					break;
				default:
					this.sendSubscriptionFail(socket, id, {
						errors: [{
							message: 'Invalid message type. Message type must be `subscription_start` or `subscription_end`.'
						}]
					});
			}
		};
	}
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2ZXIuanMiXSwibmFtZXMiOlsiRVZFTlRfS0VZIiwiU1VCU0NSSVBUSU9OX0ZBSUwiLCJTVUJTQ1JJUFRJT05fREFUQSIsIlNVQlNDUklQVElPTl9TVEFSVCIsIlNVQlNDUklQVElPTl9FTkQiLCJTVUJTQ1JJUFRJT05fU1VDQ0VTUyIsIlNlcnZlciIsImNvbnN0cnVjdG9yIiwic3Vic2NyaXB0aW9uTWFuYWdlciIsInJlZiIsIkVycm9yIiwid3MiLCJvbiIsImhhbmRsZUNvbm5lY3Rpb24iLCJiaW5kIiwic2VuZFN1YnNjcmlwdGlvbkRhdGEiLCJzb2NrZXQiLCJpZCIsInBheWxvYWQiLCJlbWl0IiwidHlwZSIsInNlbmRTdWJzY3JpcHRpb25GYWlsIiwic2VuZFN1YnNjcmlwdGlvblN1Y2Nlc3MiLCJjb25uZWN0aW9uU3Vic2NyaXB0aW9ucyIsIm9uTWVzc2FnZSIsIm9uQ2xvc2UiLCJPYmplY3QiLCJrZXlzIiwiZm9yRWFjaCIsInN1YklkIiwidW5zdWJzY3JpYmUiLCJxdWVyeSIsInZhcmlhYmxlcyIsIm9wZXJhdGlvbk5hbWUiLCJwYXJhbXMiLCJjb250ZXh0IiwiZm9ybWF0UmVzcG9uc2UiLCJ1bmRlZmluZWQiLCJmb3JtYXRFcnJvciIsImNhbGxiYWNrIiwiZXJyb3IiLCJyZXN1bHQiLCJlcnJvcnMiLCJtZXNzYWdlIiwic3Vic2NyaWJlIl0sIm1hcHBpbmdzIjoiQUFBQSxTQUFTQSxTQUFULFFBQTBCLGVBQTFCOztBQUVBLFNBQ0NDLGlCQURELEVBRUNDLGlCQUZELEVBR0NDLGtCQUhELEVBSUNDLGdCQUpELEVBS0NDLG9CQUxELFFBTU8sZ0JBTlA7O0FBUUEsZUFBZSxNQUFNQyxNQUFOLENBQWE7QUFDM0JDLGFBQVksRUFBRUMsbUJBQUYsRUFBWixFQUFxQ0MsR0FBckMsRUFBMEM7QUFDekMsTUFBSSxDQUFDRCxtQkFBTCxFQUEwQjtBQUN6QixTQUFNLElBQUlFLEtBQUosQ0FBVSxxRUFBVixDQUFOO0FBQ0E7O0FBRUQsT0FB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TVksUUFBUSxNQUFNLEtBQUtyQixtQkFBTCxDQUF5Qm9DLFNBQXpCLENBQW1DVixNQUFuQyxDQUFwQjtBQUNBWCw4QkFBd0JOLEVBQXhCLElBQThCWSxLQUE5QjtBQUNBLFdBQUtQLHVCQUFMLENBQTZCTixNQUE3QixFQUFxQ0MsRUFBckM7QUFDQSxNQUpELENBSUUsT0FBTSxFQUFFeUIsTUFBRixFQUFVQyxPQUFWLEVBQU4sRUFBMkI7QUFDNUIsVUFBSUQsTUFBSixFQUFZO0FBQ1gsWUFBS3JCLG9CQUFMLENBQTBCTCxNQUExQixFQUFrQ0MsRUFBbEMsRUFBc0MsRUFBRXlCLE1BQUYsRUFBdEM7QUFDQSxPQUZELE1BRU87QUFDTixZQUFLckIsb0JBQUwsQ0FBMEJMLE1BQTFCLEVBQWtDQyxFQUFsQyxFQUFzQyxFQUFFeUIsUUFBUSxDQUFDLEVBQUVDLE9BQUYsRUFBRCxDQUFWLEVBQXRDO0FBQ0E7QUFDRDs7QUFFRDtBQUNELFNBQUt2QyxnQkFBTDtBQUNDLFNBQUksT0FBT21CLHdCQUF3Qk4sRUFBeEIsQ0FBUCxLQUF1QyxXQUEzQyxFQUF3RDtBQUN2RCxXQUFLVCxtQkFBTCxDQUF5QnNCLFdBQXpCLENBQXFDUCx3QkFBd0JOLEVBQXhCLENBQXJDO0FBQ0EsYUFBT00sd0JBQXdCTixFQUF4QixDQUFQO0FBQ0E7O0FBRUQ7QUFDRDtBQUNDLFVBQUtJLG9CQUFMLENBQTBCTCxNQUExQixFQUFrQ0MsRUFBbEMsRUFBc0M7QUFDckN5QixjQUFRLENBQUM7QUFDUkMsZ0JBQVM7QUFERCxPQUFEO0FBRDZCLE1BQXRDO0FBOUNGO0FBb0RBLEdBckREO0FBc0RBO0FBMUcwQiIsImZpbGUiOiJzZXJ2ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFVkVOVF9LRVkgfSBmcm9tICcuL2RlZmluaXRpb25zJ1xuXG5pbXBvcnQge1xuXHRTVUJTQ1JJUFRJT05fRkFJTCxcblx0U1VCU0NSSVBUSU9OX0RBVEEsXG5cdFNVQlNDUklQVElPTl9TVEFSVCxcblx0U1VCU0NSSVBUSU9OX0VORCxcblx0U1VCU0NSSVBUSU9OX1NVQ0NFU1Ncbn0gZnJvbSAnLi9tZXNzYWdlVHlwZXMnXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNlcnZlciB7XG5cdGNvbnN0cnVjdG9yKHsgc3Vic2NyaXB0aW9uTWFuYWdlciB9LCByZWYpIHtcblx0XHRpZiAoIXN1YnNjcmlwdGlvbk1hbmFnZXIpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcignTXVzdCBwcm92aWRlIGBzdWJzY3JpcHRpb25NYW5hZ2VyYCB0byB3ZWJzb2NrZXQgc2VydmVyIGNvbnN0cnVjdG9yLicpXG5cdFx0fVxuXG5cdFx0dGhpcy53cyA9IHJlZlxuXHRcdHRoaXMuc3Vic2NyaXB0aW9uTWFuYWdlciA9IHN1YnNjcmlwdGlvbk1hbmFnZXJcblx0XHRcblx0XHR0aGlzLndzLm9uKCdjb25uZWN0aW9uJywgdGhpcy5oYW5kbGVDb25uZWN0aW9uLmJpbmQodGhpcykpXG5cdH1cblxuXHRzZW5kU3Vic2NyaXB0aW9uRGF0YShzb2NrZXQsIGlkLCBwYXlsb2FkKSB7XG5cdFx0c29ja2V0LmVtaXQoRVZFTlRfS0VZLCB7XG5cdFx0XHR0eXBlOiBTVUJTQ1JJUFRJT05fREFUQSxcblx0XHRcdGlkLFxuXHRcdFx0cGF5bG9hZFxuXHRcdH0pXG5cdH1cblxuXHRzZW5kU3Vic2NyaXB0aW9uRmFpbChzb2NrZXQsIGlkLCBwYXlsb2FkKSB7XG5cdFx0c29ja2V0LmVtaXQoRVZFTlRfS0VZLCB7XG5cdFx0XHR0eXBlOiBTVUJTQ1JJUFRJT05fRkFJTCxcblx0XHRcdGlkLFxuXHRcdFx0cGF5bG9hZFxuXHRcdH0pXG5cdH1cblxuXHRzZW5kU3Vic2NyaXB0aW9uU3VjY2Vzcyhzb2NrZXQsIGlkKSB7XG5cdFx0c29ja2V0LmVtaXQoRVZFTlRfS0VZLCB7XG5cdFx0XHR0eXBlOiBTVUJTQ1JJUFRJT05fU1VDQ0VTUyxcblx0XHRcdGlkXG5cdFx0fSlcblx0fVxuXG5cdGhhbmRsZUNvbm5lY3Rpb24oc29ja2V0KSB7XG5cdFx0Y29uc3QgY29ubmVjdGlvblN1YnNjcmlwdGlvbnMgPSB7fVxuXG5cdFx0c29ja2V0Lm9uKEVWRU5UX0tFWSwgdGhpcy5vbk1lc3NhZ2Uoc29ja2V0LCBjb25uZWN0aW9uU3Vic2NyaXB0aW9ucykpXG5cdFx0c29ja2V0Lm9uKCdkaXNjb25uZWN0JywgdGhpcy5vbkNsb3NlKHNvY2tldCwgY29ubmVjdGlvblN1YnNjcmlwdGlvbnMpKVxuXHR9XG5cblx0b25DbG9zZShzb2NrZXQsIGNvbm5lY3Rpb25TdWJzY3JpcHRpb25zKSB7XG5cdFx0cmV0dXJuICgpID0+IHtcblx0XHRcdE9iamVjdC5rZXlzKGNvbm5lY3Rpb25TdWJzY3JpcHRpb25zKS5mb3JFYWNoKCAoc3ViSWQpID0+IHtcblx0XHRcdFx0dGhpcy5zdWJzY3JpcHRpb25NYW5hZ2VyLnVuc3Vic2NyaWJlKGNvbm5lY3Rpb25TdWJzY3JpcHRpb25zW3N1YklkXSlcblx0XHRcdFx0ZGVsZXRlIGNvbm5lY3Rpb25TdWJzY3JpcHRpb25zW3N1YklkXVxuXHRcdFx0fSlcblx0XHR9XG5cdH1cblxuXHRvbk1lc3NhZ2Uoc29ja2V0LCBjb25uZWN0aW9uU3Vic2NyaXB0aW9ucykge1xuXHRcdHJldHVybiBhc3luYyAoeyBpZCwgdHlwZSwgcXVlcnksIHZhcmlhYmxlcywgb3BlcmF0aW9uTmFtZSB9KSA9PiB7XG5cdFx0XHRzd2l0Y2ggKHR5cGUpIHtcblx0XHRcdFx0Y2FzZSBTVUJTQ1JJUFRJT05fU1RBUlQ6XG5cdFx0XHRcdFx0Y29uc3QgcGFyYW1zID0ge1xuXHRcdFx0XHRcdFx0cXVlcnksXG5cdFx0XHRcdFx0XHR2YXJpYWJsZXMsXG5cdFx0XHRcdFx0XHRvcGVyYXRpb25OYW1lLFxuXHRcdFx0XHRcdFx0Y29udGV4dDoge30sXG5cdFx0XHRcdFx0XHRmb3JtYXRSZXNwb25zZTogdW5kZWZpbmVkLFxuXHRcdFx0XHRcdFx0Zm9ybWF0RXJyb3I6IHVuZGVmaW5lZCxcblx0XHRcdFx0XHRcdGNhbGxiYWNrOiAoZXJyb3IsIHJlc3VsdCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRpZiAoIWVycm9yKSB7XG5cdFx0XHRcdFx0XHRcdFx0dGhpcy5zZW5kU3Vic2NyaXB0aW9uRGF0YShzb2NrZXQsIGlkLCByZXN1bHQpXG5cdFx0XHRcdFx0XHRcdH0gZWxzZSBpZiAoZXJyb3IuZXJyb3JzKSB7XG5cdFx0XHRcdFx0XHRcdFx0dGhpcy5zZW5kU3Vic2NyaXB0aW9uRGF0YShzb2NrZXQsIGlkLCB7IGVycm9yczogZXJyb3IuZXJyb3JzIH0pXG5cdFx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdFx0dGhpcy5zZW5kU3Vic2NyaXB0aW9uRGF0YShzb2NrZXQsIGlkLCB7IGVycm9yczogW3sgbWVzc2FnZTogZXJyb3IubWVzc2FnZSB9XSB9KVxuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0aWYgKGNvbm5lY3Rpb25TdWJzY3JpcHRpb25zW2lkXSkge1xuXHRcdFx0XHRcdFx0dGhpcy5zdWJzY3JpcHRpb25NYW5hZ2VyLnVuc3Vic2NyaWJlKGNvbm5lY3Rpb25TdWJzY3JpcHRpb25zW2lkXSlcblx0XHRcdFx0XHRcdGRlbGV0ZSBjb25uZWN0aW9uU3Vic2NyaXB0aW9uc1tpZF1cblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdFx0Y29uc3Qgc3ViSWQgPSBhd2FpdCB0aGlzLnN1YnNjcmlwdGlvbk1hbmFnZXIuc3Vic2NyaWJlKHBhcmFtcylcblx0XHRcdFx0XHRcdGNvbm5lY3Rpb25TdWJzY3JpcHRpb25zW2lkXSA9IHN1YklkXG5cdFx0XHRcdFx0XHR0aGlzLnNlbmRTdWJzY3JpcHRpb25TdWNjZXNzKHNvY2tldCwgaWQpXG5cdFx0XHRcdFx0fSBjYXRjaCh7IGVycm9ycywgbWVzc2FnZSB9KSB7XG5cdFx0XHRcdFx0XHRpZiAoZXJyb3JzKSB7XG5cdFx0XHRcdFx0XHRcdHRoaXMuc2VuZFN1YnNjcmlwdGlvbkZhaWwoc29ja2V0LCBpZCwgeyBlcnJvcnMgfSlcblx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdHRoaXMuc2VuZFN1YnNjcmlwdGlvbkZhaWwoc29ja2V0LCBpZCwgeyBlcnJvcnM6IFt7IG1lc3NhZ2UgfV0gfSlcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRicmVha1xuXHRcdFx0XHRjYXNlIFNVQlNDUklQVElPTl9FTkQ6XG5cdFx0XHRcdFx0aWYgKHR5cGVvZiBjb25uZWN0aW9uU3Vic2NyaXB0aW9uc1tpZF0gIT09ICd1bmRlZmluZWQnKSB7XG5cdFx0XHRcdFx0XHR0aGlzLnN1YnNjcmlwdGlvbk1hbmFnZXIudW5zdWJzY3JpYmUoY29ubmVjdGlvblN1YnNjcmlwdGlvbnNbaWRdKVxuXHRcdFx0XHRcdFx0ZGVsZXRlIGNvbm5lY3Rpb25TdWJzY3JpcHRpb25zW2lkXVxuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGJyZWFrXG5cdFx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdFx0dGhpcy5zZW5kU3Vic2NyaXB0aW9uRmFpbChzb2NrZXQsIGlkLCB7XG5cdFx0XHRcdFx0XHRlcnJvcnM6IFt7XG5cdFx0XHRcdFx0XHRcdG1lc3NhZ2U6ICdJbnZhbGlkIG1lc3NhZ2UgdHlwZS4gTWVzc2FnZSB0eXBlIG11c3QgYmUgYHN1YnNjcmlwdGlvbl9zdGFydGAgb3IgYHN1YnNjcmlwdGlvbl9lbmRgLidcblx0XHRcdFx0XHRcdH1dXG5cdFx0XHRcdFx0fSlcblx0XHRcdH1cblx0XHR9XG5cdH1cbn1cbiJdfQ==