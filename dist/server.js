import { EVENT_KEY } from './definitions';

import subscriptionManager from './manager';

import { SUBSCRIPTION_FAIL, SUBSCRIPTION_DATA, SUBSCRIPTION_START, SUBSCRIPTION_END, SUBSCRIPTION_SUCCESS } from './messageTypes';

export default class Server {
	constructor({ schema, pubsub }, ref) {
		if (!subscriptionManager) {
			throw new Error('Must provide `subscriptionManager` to websocket server constructor.');
		}

		this.ws = ref;
		this.subscriptionManager = new subscriptionManager({ schema, pubsub });

		this.ws.on('connection', this.handleConnection.bind(this));
	}

	sendSubscriptionData(socket, id, payload) {
		socket.emit(EVENT_KEY, {
			type: SUBSCRIPTION_DATA,
			id,
			payload
		});
	}

	sendSubscriptionFail(socket, id, payload) {
		socket.emit(EVENT_KEY, {
			type: SUBSCRIPTION_FAIL,
			id,
			payload
		});
	}

	sendSubscriptionSuccess(socket, id) {
		socket.emit(EVENT_KEY, {
			type: SUBSCRIPTION_SUCCESS,
			id
		});
	}

	handleConnection(socket) {
		const connectionSubscriptions = {};

		socket.on(EVENT_KEY, this.onMessage(socket, connectionSubscriptions));
		socket.on('disconnect', this.onClose(socket, connectionSubscriptions));
	}

	onClose(socket, connectionSubscriptions) {
		return () => {
			Object.keys(connectionSubscriptions).forEach(subId => {
				this.subscriptionManager.unsubscribe(connectionSubscriptions[subId]);
				delete connectionSubscriptions[subId];
			});
		};
	}

	onMessage(socket, connectionSubscriptions) {
		return async ({ id, type, query, variables, operationName }) => {
			switch (type) {
				case SUBSCRIPTION_START:
					const params = {
						query,
						variables,
						operationName,
						context: {},
						formatResponse: undefined,
						formatError: undefined,
						callback: (error, result) => {
							if (!error) {
								this.sendSubscriptionData(socket, id, result);
							} else if (error.errors) {
								this.sendSubscriptionData(socket, id, { errors: error.errors });
							} else {
								this.sendSubscriptionData(socket, id, { errors: [{ message: error.message }] });
							}
						}
					};

					if (connectionSubscriptions[id]) {
						this.subscriptionManager.unsubscribe(connectionSubscriptions[id]);
						delete connectionSubscriptions[id];
					}

					try {
						const subId = await this.subscriptionManager.subscribe(params);
						connectionSubscriptions[id] = subId;
						this.sendSubscriptionSuccess(socket, id);
					} catch ({ errors, message }) {
						if (errors) {
							this.sendSubscriptionFail(socket, id, { errors });
						} else {
							this.sendSubscriptionFail(socket, id, { errors: [{ message }] });
						}
					}

					break;
				case SUBSCRIPTION_END:
					if (typeof connectionSubscriptions[id] !== 'undefined') {
						this.subscriptionManager.unsubscribe(connectionSubscriptions[id]);
						delete connectionSubscriptions[id];
					}

					break;
				default:
					this.sendSubscriptionFail(socket, id, {
						errors: [{
							message: 'Invalid message type. Message type must be `subscription_start` or `subscription_end`.'
						}]
					});
			}
		};
	}
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2ZXIuanMiXSwibmFtZXMiOlsiRVZFTlRfS0VZIiwic3Vic2NyaXB0aW9uTWFuYWdlciIsIlNVQlNDUklQVElPTl9GQUlMIiwiU1VCU0NSSVBUSU9OX0RBVEEiLCJTVUJTQ1JJUFRJT05fU1RBUlQiLCJTVUJTQ1JJUFRJT05fRU5EIiwiU1VCU0NSSVBUSU9OX1NVQ0NFU1MiLCJTZXJ2ZXIiLCJjb25zdHJ1Y3RvciIsInNjaGVtYSIsInB1YnN1YiIsInJlZiIsIkVycm9yIiwid3MiLCJvbiIsImhhbmRsZUNvbm5lY3Rpb24iLCJiaW5kIiwic2VuZFN1YnNjcmlwdGlvbkRhdGEiLCJzb2NrZXQiLCJpZCIsInBheWxvYWQiLCJlbWl0IiwidHlwZSIsInNlbmRTdWJzY3JpcHRpb25GYWlsIiwic2VuZFN1YnNjcmlwdGlvblN1Y2Nlc3MiLCJjb25uZWN0aW9uU3Vic2NyaXB0aW9ucyIsIm9uTWVzc2FnZSIsIm9uQ2xvc2UiLCJPYmplY3QiLCJrZXlzIiwiZm9yRWFjaCIsInN1YklkIiwidW5zdWJzY3JpYmUiLCJxdWVyeSIsInZhcmlhYmxlcyIsIm9wZXJhdGlvbk5hbWUiLCJwYXJhbXMiLCJjb250ZXh0IiwiZm9ybWF0UmVzcG9uc2UiLCJ1bmRlZmluZWQiLCJmb3JtYXRFcnJvciIsImNhbGxiYWNrIiwiZXJyb3IiLCJyZXN1bHQiLCJlcnJvcnMiLCJtZXNzYWdlIiwic3Vic2NyaWJlIl0sIm1hcHBpbmdzIjoiQUFBQSxTQUFTQSxTQUFULFFBQTBCLGVBQTFCOztBQUVBLE9BQU9DLG1CQUFQLE1BQWdDLFdBQWhDOztBQUVBLFNBQ0NDLGlCQURELEVBRUNDLGlCQUZELEVBR0NDLGtCQUhELEVBSUNDLGdCQUpELEVBS0NDLG9CQUxELFFBTU8sZ0JBTlA7O0FBUUEsZUFBZSxNQUFNQyxNQUFOLENBQWE7QUFDM0JDLGFBQVksRUFBRUMsTUFBRixFQUFVQyxNQUFWLEVBQVosRUFBZ0NDLEdBQWhDLEVBQXFDO0FBQ3BDLE1BQUksQ0FBQ1YsbUJBQUws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S2xCLG1CQUFMLENBQXlCK0IsV0FBekIsQ0FBcUNQLHdCQUF3Qk4sRUFBeEIsQ0FBckM7QUFDQSxhQUFPTSx3QkFBd0JOLEVBQXhCLENBQVA7QUFDQTs7QUFFRCxTQUFJO0FBQ0gsWUFBTVksUUFBUSxNQUFNLEtBQUs5QixtQkFBTCxDQUF5QjZDLFNBQXpCLENBQW1DVixNQUFuQyxDQUFwQjtBQUNBWCw4QkFBd0JOLEVBQXhCLElBQThCWSxLQUE5QjtBQUNBLFdBQUtQLHVCQUFMLENBQTZCTixNQUE3QixFQUFxQ0MsRUFBckM7QUFDQSxNQUpELENBSUUsT0FBTSxFQUFFeUIsTUFBRixFQUFVQyxPQUFWLEVBQU4sRUFBMkI7QUFDNUIsVUFBSUQsTUFBSixFQUFZO0FBQ1gsWUFBS3JCLG9CQUFMLENBQTBCTCxNQUExQixFQUFrQ0MsRUFBbEMsRUFBc0MsRUFBRXlCLE1BQUYsRUFBdEM7QUFDQSxPQUZELE1BRU87QUFDTixZQUFLckIsb0JBQUwsQ0FBMEJMLE1BQTFCLEVBQWtDQyxFQUFsQyxFQUFzQyxFQUFFeUIsUUFBUSxDQUFDLEVBQUVDLE9BQUYsRUFBRCxDQUFWLEVBQXRDO0FBQ0E7QUFDRDs7QUFFRDtBQUNELFNBQUt4QyxnQkFBTDtBQUNDLFNBQUksT0FBT29CLHdCQUF3Qk4sRUFBeEIsQ0FBUCxLQUF1QyxXQUEzQyxFQUF3RDtBQUN2RCxXQUFLbEIsbUJBQUwsQ0FBeUIrQixXQUF6QixDQUFxQ1Asd0JBQXdCTixFQUF4QixDQUFyQztBQUNBLGFBQU9NLHdCQUF3Qk4sRUFBeEIsQ0FBUDtBQUNBOztBQUVEO0FBQ0Q7QUFDQyxVQUFLSSxvQkFBTCxDQUEwQkwsTUFBMUIsRUFBa0NDLEVBQWxDLEVBQXNDO0FBQ3JDeUIsY0FBUSxDQUFDO0FBQ1JDLGdCQUFTO0FBREQsT0FBRDtBQUQ2QixNQUF0QztBQTlDRjtBQW9EQSxHQXJERDtBQXNEQTtBQTFHMEIiLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRVZFTlRfS0VZIH0gZnJvbSAnLi9kZWZpbml0aW9ucydcblxuaW1wb3J0IHN1YnNjcmlwdGlvbk1hbmFnZXIgZnJvbSAnLi9tYW5hZ2VyJ1xuXG5pbXBvcnQge1xuXHRTVUJTQ1JJUFRJT05fRkFJTCxcblx0U1VCU0NSSVBUSU9OX0RBVEEsXG5cdFNVQlNDUklQVElPTl9TVEFSVCxcblx0U1VCU0NSSVBUSU9OX0VORCxcblx0U1VCU0NSSVBUSU9OX1NVQ0NFU1Ncbn0gZnJvbSAnLi9tZXNzYWdlVHlwZXMnXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNlcnZlciB7XG5cdGNvbnN0cnVjdG9yKHsgc2NoZW1hLCBwdWJzdWIgfSwgcmVmKSB7XG5cdFx0aWYgKCFzdWJzY3JpcHRpb25NYW5hZ2VyKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ011c3QgcHJvdmlkZSBgc3Vic2NyaXB0aW9uTWFuYWdlcmAgdG8gd2Vic29ja2V0IHNlcnZlciBjb25zdHJ1Y3Rvci4nKVxuXHRcdH1cblxuXHRcdHRoaXMud3MgPSByZWZcblx0XHR0aGlzLnN1YnNjcmlwdGlvbk1hbmFnZXIgPSBuZXcgc3Vic2NyaXB0aW9uTWFuYWdlcih7IHNjaGVtYSwgcHVic3ViIH0pXG5cdFx0XG5cdFx0dGhpcy53cy5vbignY29ubmVjdGlvbicsIHRoaXMuaGFuZGxlQ29ubmVjdGlvbi5iaW5kKHRoaXMpKVxuXHR9XG5cblx0c2VuZFN1YnNjcmlwdGlvbkRhdGEoc29ja2V0LCBpZCwgcGF5bG9hZCkge1xuXHRcdHNvY2tldC5lbWl0KEVWRU5UX0tFWSwge1xuXHRcdFx0dHlwZTogU1VCU0NSSVBUSU9OX0RBVEEsXG5cdFx0XHRpZCxcblx0XHRcdHBheWxvYWRcblx0XHR9KVxuXHR9XG5cblx0c2VuZFN1YnNjcmlwdGlvbkZhaWwoc29ja2V0LCBpZCwgcGF5bG9hZCkge1xuXHRcdHNvY2tldC5lbWl0KEVWRU5UX0tFWSwge1xuXHRcdFx0dHlwZTogU1VCU0NSSVBUSU9OX0ZBSUwsXG5cdFx0XHRpZCxcblx0XHRcdHBheWxvYWRcblx0XHR9KVxuXHR9XG5cblx0c2VuZFN1YnNjcmlwdGlvblN1Y2Nlc3Moc29ja2V0LCBpZCkge1xuXHRcdHNvY2tldC5lbWl0KEVWRU5UX0tFWSwge1xuXHRcdFx0dHlwZTogU1VCU0NSSVBUSU9OX1NVQ0NFU1MsXG5cdFx0XHRpZFxuXHRcdH0pXG5cdH1cblxuXHRoYW5kbGVDb25uZWN0aW9uKHNvY2tldCkge1xuXHRcdGNvbnN0IGNvbm5lY3Rpb25TdWJzY3JpcHRpb25zID0ge31cblxuXHRcdHNvY2tldC5vbihFVkVOVF9LRVksIHRoaXMub25NZXNzYWdlKHNvY2tldCwgY29ubmVjdGlvblN1YnNjcmlwdGlvbnMpKVxuXHRcdHNvY2tldC5vbignZGlzY29ubmVjdCcsIHRoaXMub25DbG9zZShzb2NrZXQsIGNvbm5lY3Rpb25TdWJzY3JpcHRpb25zKSlcblx0fVxuXG5cdG9uQ2xvc2Uoc29ja2V0LCBjb25uZWN0aW9uU3Vic2NyaXB0aW9ucykge1xuXHRcdHJldHVybiAoKSA9PiB7XG5cdFx0XHRPYmplY3Qua2V5cyhjb25uZWN0aW9uU3Vic2NyaXB0aW9ucykuZm9yRWFjaCggKHN1YklkKSA9PiB7XG5cdFx0XHRcdHRoaXMuc3Vic2NyaXB0aW9uTWFuYWdlci51bnN1YnNjcmliZShjb25uZWN0aW9uU3Vic2NyaXB0aW9uc1tzdWJJZF0pXG5cdFx0XHRcdGRlbGV0ZSBjb25uZWN0aW9uU3Vic2NyaXB0aW9uc1tzdWJJZF1cblx0XHRcdH0pXG5cdFx0fVxuXHR9XG5cblx0b25NZXNzYWdlKHNvY2tldCwgY29ubmVjdGlvblN1YnNjcmlwdGlvbnMpIHtcblx0XHRyZXR1cm4gYXN5bmMgKHsgaWQsIHR5cGUsIHF1ZXJ5LCB2YXJpYWJsZXMsIG9wZXJhdGlvbk5hbWUgfSkgPT4ge1xuXHRcdFx0c3dpdGNoICh0eXBlKSB7XG5cdFx0XHRcdGNhc2UgU1VCU0NSSVBUSU9OX1NUQVJUOlxuXHRcdFx0XHRcdGNvbnN0IHBhcmFtcyA9IHtcblx0XHRcdFx0XHRcdHF1ZXJ5LFxuXHRcdFx0XHRcdFx0dmFyaWFibGVzLFxuXHRcdFx0XHRcdFx0b3BlcmF0aW9uTmFtZSxcblx0XHRcdFx0XHRcdGNvbnRleHQ6IHt9LFxuXHRcdFx0XHRcdFx0Zm9ybWF0UmVzcG9uc2U6IHVuZGVmaW5lZCxcblx0XHRcdFx0XHRcdGZvcm1hdEVycm9yOiB1bmRlZmluZWQsXG5cdFx0XHRcdFx0XHRjYWxsYmFjazogKGVycm9yLCByZXN1bHQpID0+IHtcblx0XHRcdFx0XHRcdFx0aWYgKCFlcnJvcikge1xuXHRcdFx0XHRcdFx0XHRcdHRoaXMuc2VuZFN1YnNjcmlwdGlvbkRhdGEoc29ja2V0LCBpZCwgcmVzdWx0KVxuXHRcdFx0XHRcdFx0XHR9IGVsc2UgaWYgKGVycm9yLmVycm9ycykge1xuXHRcdFx0XHRcdFx0XHRcdHRoaXMuc2VuZFN1YnNjcmlwdGlvbkRhdGEoc29ja2V0LCBpZCwgeyBlcnJvcnM6IGVycm9yLmVycm9ycyB9KVxuXHRcdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRcdHRoaXMuc2VuZFN1YnNjcmlwdGlvbkRhdGEoc29ja2V0LCBpZCwgeyBlcnJvcnM6IFt7IG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfV0gfSlcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGlmIChjb25uZWN0aW9uU3Vic2NyaXB0aW9uc1tpZF0pIHtcblx0XHRcdFx0XHRcdHRoaXMuc3Vic2NyaXB0aW9uTWFuYWdlci51bnN1YnNjcmliZShjb25uZWN0aW9uU3Vic2NyaXB0aW9uc1tpZF0pXG5cdFx0XHRcdFx0XHRkZWxldGUgY29ubmVjdGlvblN1YnNjcmlwdGlvbnNbaWRdXG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0dHJ5IHtcblx0XHRcdFx0XHRcdGNvbnN0IHN1YklkID0gYXdhaXQgdGhpcy5zdWJzY3JpcHRpb25NYW5hZ2VyLnN1YnNjcmliZShwYXJhbXMpXG5cdFx0XHRcdFx0XHRjb25uZWN0aW9uU3Vic2NyaXB0aW9uc1tpZF0gPSBzdWJJZFxuXHRcdFx0XHRcdFx0dGhpcy5zZW5kU3Vic2NyaXB0aW9uU3VjY2Vzcyhzb2NrZXQsIGlkKVxuXHRcdFx0XHRcdH0gY2F0Y2goeyBlcnJvcnMsIG1lc3NhZ2UgfSkge1xuXHRcdFx0XHRcdFx0aWYgKGVycm9ycykge1xuXHRcdFx0XHRcdFx0XHR0aGlzLnNlbmRTdWJzY3JpcHRpb25GYWlsKHNvY2tldCwgaWQsIHsgZXJyb3JzIH0pXG5cdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHR0aGlzLnNlbmRTdWJzY3JpcHRpb25GYWlsKHNvY2tldCwgaWQsIHsgZXJyb3JzOiBbeyBtZXNzYWdlIH1dIH0pXG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0YnJlYWtcblx0XHRcdFx0Y2FzZSBTVUJTQ1JJUFRJT05fRU5EOlxuXHRcdFx0XHRcdGlmICh0eXBlb2YgY29ubmVjdGlvblN1YnNjcmlwdGlvbnNbaWRdICE9PSAndW5kZWZpbmVkJykge1xuXHRcdFx0XHRcdFx0dGhpcy5zdWJzY3JpcHRpb25NYW5hZ2VyLnVuc3Vic2NyaWJlKGNvbm5lY3Rpb25TdWJzY3JpcHRpb25zW2lkXSlcblx0XHRcdFx0XHRcdGRlbGV0ZSBjb25uZWN0aW9uU3Vic2NyaXB0aW9uc1tpZF1cblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRicmVha1xuXHRcdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRcdHRoaXMuc2VuZFN1YnNjcmlwdGlvbkZhaWwoc29ja2V0LCBpZCwge1xuXHRcdFx0XHRcdFx0ZXJyb3JzOiBbe1xuXHRcdFx0XHRcdFx0XHRtZXNzYWdlOiAnSW52YWxpZCBtZXNzYWdlIHR5cGUuIE1lc3NhZ2UgdHlwZSBtdXN0IGJlIGBzdWJzY3JpcHRpb25fc3RhcnRgIG9yIGBzdWJzY3JpcHRpb25fZW5kYC4nXG5cdFx0XHRcdFx0XHR9XVxuXHRcdFx0XHRcdH0pXG5cdFx0XHR9XG5cdFx0fVxuXHR9XG59XG4iXX0=